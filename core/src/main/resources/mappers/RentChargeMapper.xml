<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lanswon.estate.mapper.RentChargeMapper">


    <select id="getRentChargeInfoByDealId" resultType="com.lanswon.estate.bean.vo.MonthRentChargeVO">
        SELECT t.id,
               concat(t.rent_year, '年', t.rent_month, '月')                                         AS rentMonth,
               t.must_charge,
               t.actual_charge,
               t.arrears,
               CASE t.is_enable WHEN 1 THEN '正常' WHEN 2 THEN '未启用(合同未审核)' WHEN 3 THEN '合同取消' END AS rentStatus
        FROM money_rent_must t
        WHERE 1 = 1
          AND t.fk_deal_id = #{id}
    </select>


    <select id="generateTail" resultType="java.lang.Double">
        SELECT datediff(max(t.rent_date), date(#{date})) * (t2.real_rent_charge / 30)
        FROM money_rent_must t
                 LEFT JOIN deal t1 ON t1.id = t.fk_deal_id
                 LEFT JOIN house_resource t2 ON t1.fk_house_resource_id = t2.id
        WHERE t1.id = #{id}
          AND t.is_enable = 1
    </select>
    <select id="getRentWarnPage" resultType="com.lanswon.estate.bean.vo.SimpleWarnRentVO">
        SELECT t1.deal_serial,
               t1.deal_name,
               t2.resource_name,
               t3.name                                     AS renter,
               concat(t.rent_year, '年', t.rent_month, '月') AS rentMonth,
               t.must_charge,
               to_days(t.rent_date) - to_days(now())       AS lastDay
        FROM money_rent_must t
                 LEFT JOIN deal t1 ON t.fk_deal_id = t1.id
                 LEFT JOIN house_resource t2 ON t1.fk_house_resource_id = t2.id
                 LEFT JOIN renter t3 ON t1.fk_renter_id = t3.id
        WHERE DATE_ADD(now(), INTERVAL #{day} DAY) &gt;= t.rent_date
          AND t.is_enable = 1
    </select>
    <update id="freezeRentCharge">
        UPDATE money_rent_must t
        SET t.is_enable = 3
        WHERE t.fk_deal_id = #{id}
          AND t.rent_date &gt;= #{date}
    </update>
</mapper>
